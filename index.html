<!DOCTYPE html>
<html lang="fi">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <style>
      body {
        background-color: black;
        overflow: hidden;
      }
    </style>
    <script type="module">
      // TODO: Use kaboom library
      import kaboom from 'https://unpkg.com/kaboom/dist/kaboom.mjs';

      // TODO: Initialize kaboom library
      kaboom({
        global: true,
        fullscreen: true,
        scale: 2,
        debug: true,
        background: [51, 151, 255], // RGB
      });

      // TODO: Settings
      const MOVE_SPEED = 120;
      const JUMP_FORCE = 550;
      let pisteet = 0;

      // TODO: Import graphics
      loadSprite('logo', 'Kuvat/keuda_logo.png');
      loadSprite('bg', 'Kuvat/tausta.png');
      loadSprite('ground', 'Kuvat/tausta_alareuna.png');
      loadSprite('mario', 'Kuvat/hahmo.png');
      loadSprite('pahis', 'Kuvat/örkki.png');
      loadSprite('block', 'Kuvat/block.png');
      loadSprite('surprise', 'Kuvat/block_kysymys.png');
      loadSprite('coin', 'Kuvat/coin.png');
      loadSprite('ruskea-palikka', 'Kuvat/block_tyhjä.png');
      loadSprite('cloud', 'Kuvat/pilvi.png');

      // TODO: Set graphics
      add([sprite('bg', { width: width(), height: height() }), pos(0, 0), fixed()]);
      add([sprite('ground', { width: 2000, height: 150 }), pos(0, 500), fixed()]);
      add([sprite('logo', { width: 150, height: 50 }), pos(0, 580), fixed()]);

      // TODO: Create player
      const player = add([sprite('mario'), solid(), pos(50, 0), body(), area(), scale(0.7), origin('bot')]);

      // TODO: Create layers
      layers(['bg', 'obj', 'ui'], 'obj');

      // TODO: Create levels
      const levels = [
        [
          '£                                                                       £',
          '£                                                                       £',
          '£                                                                       £',
          '£                                                                       £',
          '£                                                                       £',
          '£    %   =*=%=         %           %       %       o                    £',
          '£                                                                       £',
          '£                                                                    -+ £',
          '£                   ^   ^                                            () £',
          '==============================   ========================================',
        ],
        [
          '£                               *                                       £',
          '£                                                                       £',
          '£                                                                       £',
          '£                                                                       £',
          '£                              x                %                       £',
          '£        ===%%=              x x                                        £',
          '£                          x x x                                        £',
          '£                        x x x x  x             x                     -+£',
          '£               ^   ^  x x x x x  x            x                      ()£',
          '=========================================  ===============  =============',
        ],
        [
          '£                                                                       £',
          '£                              %                                        £',
          '£          *                                                            £',
          '£                                                                       £',
          '£                                                                       £',
          '£        @%@%%@              x x                                        £',
          '£                          x x x                                        £',
          '£                        x x x x  x               x                   -+£',
          '£           #    ^   ^  x x x x x  x               x           x      ()£',
          '=========================================  ===============  =============',
        ],
      ];

      addLevel(levels[2], {
        width: 20,
        height: 20,
        '=': () => [sprite('block'), solid(), area(), scale(0.44), 'Maa'],
        '£': () => [sprite('block'), solid(), area(), scale(0.44), 'Seinä'],
        '%': () => [sprite('surprise'), solid(), area(), scale(0.4), 'surprise'],
        '*': () => [sprite('cloud'), scale(0.3), layer('bg'), 'Pilvi'],
        '#': () => [sprite('pahis'), solid(), area(), scale(1), 'Örkki'],
        '$': () => [sprite('coin'), 'coin', solid(), area()],
        '¤': () => [sprite('ruskea-palikka'), 'ruskea-palikka'],
      });

      // TODO: If player hit the suprise
      player.onCollide('surprise', (surprise) => {
        let x = surprise.pos.x;
        let y = surprise.pos.y;
        add([pos(x , y + -15), sprite('coin')]);
        destroy(surprise);
        add([pos(x, y), sprite('ruskea-palikka'), area(), solid(), scale(0.4)]);
      });

      // Points
      const pisteTaulu = add([
        text(pisteet),
        pos(90, 6),
        scale(0.15),
        fixed(),
        layer('ui'),
        {
          value: pisteet,
        }
      ])

      add([
        text('Pisteet: '),
        pos(30, 6),
        scale(0.15),
        fixed(),
      ])

      player.onCollide('coin', (c) => {
        destroy(c)
        pisteTaulu.value++
        pisteTaulu.text = pisteTaulu.value
      })

      // "Örkki" moves
      onUpdate('Örkki', (p) => {
        p.move(-15, 0);
      })

      // If player touches "Örkki" then screen will shake
      player.onCollide('Örkki', (Örkki) => {
        shake(5);
      })

      // TODO: Make sure camera keeps following player
      player.onUpdate(() => {
        camPos(player.pos);
      });

      // TODO: Movement
      onKeyDown('left', () => {
        player.move(-MOVE_SPEED, 0);
        camPos(player.pos);
        player.flipX(true);
      });

      onKeyDown('right', () => {
        player.move(MOVE_SPEED, 0);
        camPos(player.pos);
        player.flipX(false);
      });

      // TODO: Jump
      onKeyPress('space', () => {
        if (player.isGrounded()) {
          player.jump(JUMP_FORCE, 0);
        }
      });

      onKeyPress('up', () => {
        if (player.isGrounded()) {
          player.jump(JUMP_FORCE, 0);
        }
      });
    </script>
  </body>
</html>
